#!/usr/bin/env perl

# this script
#
#	* runs composer on the zend framework
#	* builds the coffeescript
#	* copies all of the source code into /opt/whathood
#	* kills any watchers and then restarts them
#

use lib 'libs/perl';
use strict;
use warnings;
use FindBin;
use Cwd;

use Whathood::Utils;

Whathood::Utils->check_run_as_root();


Whathood::Utils->prompt_user('are you sure you want to deploy?');


# current directory
my $DIR=$FindBin::Bin;

# deploy to
my $DEST_DIR="/opt/whathood";
my $SRC_DIR="$DIR/..";

print "Building Whathood App\n";
run_composer();
run_grunt_coffee();
copy_to_opt();


sub run_composer {

	chdir "$SRC_DIR/app";

	print "*     installing composer\n";
	`curl -sS https://getcomposer.org/installer | php > /dev/null 2>&1`;

	print "*     installing vendor libraries\n";
	`php composer.phar install > /dev/null 2>&1`;
}

sub run_grunt_coffee {

	# make sure we have all the grunt tasks
	print "*     run_grunt_coffee....\n";
	chdir $SRC_DIR;
	system('make grunt --save-deps') or die("unable to make grunt: $?");

	# now build our coffeescript files
	print "*     building coffeescript files\n";
	my $result = system('grunt coffee');
	die("unable to run grunt coffee: $?") if $result;
}

sub copy_to_opt {
	print "*     copying files from $SRC_DIR to $DEST_DIR\n";
	my $cmd = "rsync -av $SRC_DIR/app/ $DEST_DIR/app";
	system($cmd);
	print "*     setting doctrine proxy dest dir to all writeable\n";
	`mkdir -p $DEST_DIR/app/data/DoctrineORMModule`;
	`chmod 777 $DEST_DIR/app/data/DoctrineORMModule -R`;
}

sub init_whathood_watch {
	print "*     starting whathood watch process\n";
    system("/opt/whathood/run-app watch");
}
