#!/bin/bash

# change to app root
DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
cd $DIR/..

# --tuples-only doesn't print out extra info like totals or column names

GRID_RES=.003
DBNAME=jim_whathood
SCRIPT_DIR=app/scripts/sql

# the test neighborhood_id
TEST_NEIGHBORHOOD_ID=89

# the test user polygon id
TEST_UP_ID=174

function exec_sql {
  echo $1
  tuples="--tuples-only"
  if [ "$2" == "--tuples" ]
  then
      tuples=""
  fi
  psql $tuples $DBNAME -c "$1"
}

function run_sql_script {
  #echo 'running script ' $@
  psql --tuples-only --quiet $DBNAME -f "$@"
}

./bin/load_sql_functions

#
#  get the user polygon count per test point
#
echo ""
echo ""
echo "running sql command:"
sql_cmd="SELECT (whathood.gather_test_point_counts(whathood.makegrid_2d(ST_Collect(up.polygon),$GRID_RES),$TEST_NEIGHBORHOOD_ID)).*
  FROM user_polygon up
  INNER JOIN neighborhood n ON n.id = up.neighborhood_id
  WHERE n.id = $TEST_NEIGHBORHOOD_ID"
echo ""
echo ""
exec_sql "$sql_cmd" --tuples
