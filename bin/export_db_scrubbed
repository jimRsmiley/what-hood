#!/usr/bin/env ruby

backup_dir = get_backup_dir

puts "backing up schema"
backup_schema backup_dir

puts "backing up data"
backup_data backup_dir

puts "data dumperd to directory #{backup_dir}"
commit_and_push backup_dir

BEGIN {

    def get_backup_dir
        bin_dir = File.dirname(__FILE__)
        cwd = Dir.pwd
        abs_path = "#{cwd}/#{bin_dir}"
        backup_dir="#{abs_path}/../data/whathood_db"
        return backup_dir
    end

    def backup_data(backup_dir)
        cmd="pg_dump --no-owner --data-only whathood > #{backup_dir}/whathood_data.sql"
        system cmd
    end

    def backup_schema(backup_dir)
        cmd="pg_dump --no-owner --schema-only whathood > #{backup_dir}/whathood_schema.sql"
        system cmd
    end

    def commit_and_push(backup_dir)
        Dir.chdir backup_dir
        time = Time.new
        `git add -A`
        `git commit -m "re-exported whathood sql created at #{time}"`
        `git push`
    end
}
