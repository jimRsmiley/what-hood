#!/usr/bin/env perl

use strict;
use warnings;
use FindBin;

my $user=`whoami`;
chomp $user;
unless ( $user eq "root" ) {
   print "must be run as root. Not '$user'\n";
   exit;
}

# current directory
my $DIR=$FindBin::Bin;

# deploy to
my $DEST_DIR="/opt/whathood";
my $SRC_DIR="$DIR/..";

print "\n";
print "Building Whathood App\n";
print "\n";

chdir "$SRC_DIR/app";

print "*     installing composer\n";
`curl -sS https://getcomposer.org/installer | php > /dev/null`;

print "*     installing vendor libraries\n";
`php composer.phar install > /dev/null`;

#print "*     copying over ZcfUser config files\b";
#`cp $SRC_DIR/dev-bin/provision/ZfcUserDoctrineORM.Entity.User.dcm.xml $SRC_DIR/app/vendor/zf-commons/zfc-user-doctrine-orm/config/xml/zfcuserdoctrineorm -f`;
#`cp $SRC_DIR/dev-bin/provision/ZfcUser.Entity.User.dcm.xml $SRC_DIR/app/vendor/zf-commons/zfc-user-doctrine-orm/config/xml/zfcuser/ -f`;

print "*     building Whathood's coffeescript(to do)\n";
print "*     building grunt\n";
# DO NOT SUDO GRUNT
chdir $DEST_DIR;
`npm config set loglevel warn`;
`npm install --silent grunt --save-dev > /dev/null`;
`npm install --silent grunt-contrib-watch --save-dev > /dev/null`;
`npm install --silent grunt-contrib-coffee --save-dev > /dev/null`;

print "*     building coffeescript into whathood-compiled.js\n";
`grunt coffee > /dev/null`;

print "*     making source dir chmod 777\n";
`chmod 755 $SRC_DIR -R`;

print "*     setting doctrine proxy dir to all writeable\n";
`mkdir -p $SRC_DIR/app/data/DoctrineORMModule`;
`chmod 755 $SRC_DIR/app/data/DoctrineORMModule`;

print "*     now copy everything to the destination dir\n";
`sudo mkdir -p $DEST_DIR`;

print "*     copying whathood zend files from $SRC_DIR/app to $DEST_DIR\n";
`cp -r $SRC_DIR/ $DEST_DIR`;

print "*     copying over whathood.conf nginx file\n";
`cp -f $SRC_DIR/etc/nginx/whathood.conf /etc/nginx/sites-available/whathood.conf`;

print "*     restarting nginx\n";
`service nginx restart`;

print "done deploy\n";
